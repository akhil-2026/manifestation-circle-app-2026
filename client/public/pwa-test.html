<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Installation Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #0f172a;
            color: white;
        }
        .test-item {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 5px;
        }
        .success { border-color: #22c55e; background: rgba(34, 197, 94, 0.1); }
        .error { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .warning { border-color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
        button {
            background: #7c3aed;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #6d28d9; }
        #results { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>ğŸŒ™ PWA Installation Test</h1>
    <p>This page will help diagnose PWA installation issues.</p>
    
    <button onclick="runTests()">ğŸ” Run PWA Tests</button>
    <button onclick="testInstall()">ğŸ“± Test Install Prompt</button>
    <button onclick="checkManifest()">ğŸ“‹ Check Manifest</button>
    
    <div id="results"></div>
    
    <script>
        let deferredPrompt;
        
        // Listen for install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('ğŸ“± Install prompt available');
            e.preventDefault();
            deferredPrompt = e;
            addResult('Install prompt detected!', 'success');
        });
        
        // Listen for app installed
        window.addEventListener('appinstalled', () => {
            console.log('âœ… App installed');
            addResult('App installed successfully!', 'success');
        });
        
        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-item ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }
        
        function runTests() {
            document.getElementById('results').innerHTML = '';
            addResult('ğŸ” Running PWA Tests...', 'info');
            
            // Test 1: HTTPS
            if (location.protocol === 'https:' || location.hostname === 'localhost') {
                addResult('âœ… HTTPS: Secure connection detected', 'success');
            } else {
                addResult('âŒ HTTPS: Insecure connection (PWA requires HTTPS)', 'error');
            }
            
            // Test 2: Service Worker Support
            if ('serviceWorker' in navigator) {
                addResult('âœ… Service Worker: Browser supports service workers', 'success');
                
                // Check if service worker is registered
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    if (registrations.length > 0) {
                        addResult(`âœ… Service Worker: ${registrations.length} worker(s) registered`, 'success');
                    } else {
                        addResult('âš ï¸ Service Worker: No workers registered yet', 'warning');
                    }
                });
            } else {
                addResult('âŒ Service Worker: Not supported in this browser', 'error');
            }
            
            // Test 3: Manifest
            const manifestLink = document.querySelector('link[rel="manifest"]');
            if (manifestLink) {
                addResult('âœ… Manifest: Link found in HTML', 'success');
                
                // Try to fetch manifest
                fetch(manifestLink.href)
                    .then(response => {
                        if (response.ok) {
                            return response.json();
                        }
                        throw new Error(`HTTP ${response.status}`);
                    })
                    .then(manifest => {
                        addResult(`âœ… Manifest: Successfully loaded (${manifest.name})`, 'success');
                        addResult(`ğŸ“± Display: ${manifest.display}`, 'info');
                        addResult(`ğŸ¨ Theme: ${manifest.theme_color}`, 'info');
                        addResult(`ğŸ“ Icons: ${manifest.icons.length} icon(s) defined`, 'info');
                    })
                    .catch(error => {
                        addResult(`âŒ Manifest: Failed to load (${error.message})`, 'error');
                    });
            } else {
                addResult('âŒ Manifest: No manifest link found in HTML', 'error');
            }
            
            // Test 4: Install Criteria
            if (window.matchMedia('(display-mode: standalone)').matches) {
                addResult('âœ… Already installed as PWA', 'success');
            } else {
                addResult('ğŸ“± Not installed - can be installed as PWA', 'info');
            }
            
            // Test 5: Browser Support
            const userAgent = navigator.userAgent;
            if (userAgent.includes('Chrome')) {
                addResult('âœ… Browser: Chrome (Full PWA support)', 'success');
            } else if (userAgent.includes('Safari')) {
                addResult('âš ï¸ Browser: Safari (Manual installation only)', 'warning');
            } else if (userAgent.includes('Firefox')) {
                addResult('âš ï¸ Browser: Firefox (Limited PWA support)', 'warning');
            } else {
                addResult('â“ Browser: Unknown PWA support', 'warning');
            }
        }
        
        function testInstall() {
            if (deferredPrompt) {
                addResult('ğŸ“± Showing install prompt...', 'info');
                deferredPrompt.prompt();
                
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        addResult('âœ… User accepted install prompt', 'success');
                    } else {
                        addResult('âŒ User dismissed install prompt', 'warning');
                    }
                    deferredPrompt = null;
                });
            } else {
                addResult('âŒ No install prompt available', 'error');
                addResult('ğŸ’¡ Try: Browser menu â†’ "Add to Home Screen"', 'info');
            }
        }
        
        function checkManifest() {
            addResult('ğŸ“‹ Checking manifest accessibility...', 'info');
            
            const manifestUrl = '/manifest.json';
            fetch(manifestUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(manifest => {
                    addResult('âœ… Manifest is accessible', 'success');
                    addResult(`ğŸ“± App Name: ${manifest.name}`, 'info');
                    addResult(`ğŸ·ï¸ Short Name: ${manifest.short_name}`, 'info');
                    addResult(`ğŸ–¥ï¸ Display Mode: ${manifest.display}`, 'info');
                    addResult(`ğŸ¯ Start URL: ${manifest.start_url}`, 'info');
                    addResult(`ğŸ¨ Theme Color: ${manifest.theme_color}`, 'info');
                    addResult(`ğŸ“ Orientation: ${manifest.orientation}`, 'info');
                    
                    // Check icons
                    manifest.icons.forEach((icon, index) => {
                        addResult(`ğŸ–¼ï¸ Icon ${index + 1}: ${icon.sizes} (${icon.type})`, 'info');
                    });
                })
                .catch(error => {
                    addResult(`âŒ Manifest error: ${error.message}`, 'error');
                });
        }
        
        // Auto-run tests on load
        setTimeout(runTests, 1000);
    </script>
</body>
</html>